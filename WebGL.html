<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebGL</title>
    <script src="https://cdn.jsdelivr.net/npm/@assemblyscript/loader/umd/index.js"></script>
  </head>
  <body>
    <script type="module">
      (async function main() {
        const canvas = document.createElement('canvas');
        const gl = canvas.getContext('webgl');
        document.body.append(canvas);

        let success;

        const VS_SHADER = `
        attribute vec2 a_position;

        void main() {
          gl_Position = vec4(a_position, 0, 1);
        }
        `;
        const FS_SHADER = `
        precision mediump float;

        void main() {
          gl_FragColor = vec4(0, 0.5, 1, 1);
        }
        `;

        // 先回忆一下怎么绘制三角形的。。。这东西不使用就会忘记的了
        const vs = gl.createShader(gl.VERTEX_SHADER);
        gl.shaderSource(vs, VS_SHADER);
        gl.compileShader(vs);
        success = gl.getShaderParameter(vs, gl.COMPILE_STATUS);
        if (!success)
          return console.log(
            'compile   vs shader fail',
            gl.getShaderInfoLog(vs),
          );

        const fs = gl.createShader(gl.FRAGMENT_SHADER);
        gl.shaderSource(fs, FS_SHADER);
        gl.compileShader(fs);
        success = gl.getShaderParameter(fs, gl.COMPILE_STATUS);
        if (!success)
          return console.log('compile fs shader fail', gl.getShaderInfoLog(fs));

        const program = gl.createProgram();
        gl.attachShader(program, vs);
        gl.attachShader(program, fs);
        gl.linkProgram(program);
        success = gl.getProgramParameter(program, gl.LINK_STATUS);
        if (!success)
          return console.log(
            'link program fail',
            gl.getProgramInfoLog(program),
          );

        const positionLocation = gl.getAttribLocation(program, 'a_position');
        const positionBuffer = gl.createBuffer();

        gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
        gl.bufferData(
          gl.ARRAY_BUFFER,
          new Float32Array([0, 0.5, -0.5, 0, 0.5, 0]),
          gl.STATIC_DRAW,
        );

        gl.useProgram(program);
        gl.enableVertexAttribArray(positionLocation);
        gl.vertexAttribPointer(positionLocation, 2, gl.FLOAT, false, 0, 0);

        gl.drawArrays(gl.TRIANGLES, 0, 3);
        // 这是最基本的webgl使用方式，其实就是一堆修改webgl状态机的API
      })();
    </script>

    <script type="module">
      const canvas = document.createElement('canvas');
      const gl = canvas.getContext('webgl');
      document.body.append(canvas);

      const memory = new WebAssembly.Memory({ initial: 1 });

      const FN_MAP = [
        'createShader',
        'shaderSource',
        'compileShader',
        'getShaderParameter',
        'getShaderInfoLog',

        'createProgram',
        'attachShader',
        'linkProgram',
        'getProgramParameter',
        'getProgramInfoLog',

        'getAttribLocation',
        'createBuffer',
        'bindBuffer',
        'bufferData',
        'useProgram',
        'enableVertexAttribArray',
        'drawArrays',
        'vertexAttribPointer',
      ];

      loader.instantiate(
        fetch('./build/webgl.wasm').then(i => i.arrayBuffer()),
        {
          env: { memory },
          webgl: { glCall() {} },
        },
      );
    </script>
  </body>
</html>
